# -*- coding: utf-8 -*-

import numpy as np

import astropy.units as u
import astropy.constants as const

from scipy.special import jv
from tqdm import tqdm


LISA_signal_response_function_fscaled = np.array(
      [1.023300e-05, 1.047143e-05, 1.071541e-05, 1.096508e-05, 1.122057e-05, 1.148201e-05, 1.174954e-05, 1.202330e-05, 1.230345e-05, 1.259012e-05,
       1.288347e-05, 1.318365e-05, 1.349083e-05, 1.380517e-05, 1.412683e-05, 1.445598e-05, 1.479281e-05, 1.513748e-05, 1.549018e-05, 1.585110e-05,
       1.622043e-05, 1.659837e-05, 1.698511e-05, 1.738086e-05, 1.778584e-05, 1.820025e-05, 1.862431e-05, 1.905826e-05, 1.950232e-05, 1.995672e-05,
       2.042171e-05, 2.089754e-05, 2.138445e-05, 2.188271e-05, 2.239258e-05, 2.291433e-05, 2.344823e-05, 2.399457e-05, 2.455365e-05, 2.512575e-05,
       2.571118e-05, 2.631025e-05, 2.692328e-05, 2.755059e-05, 2.819252e-05, 2.884940e-05, 2.952159e-05, 3.020945e-05, 3.091333e-05, 3.163361e-05,
       3.237067e-05, 3.312491e-05, 3.389672e-05, 3.468651e-05, 3.549471e-05, 3.632173e-05, 3.716803e-05, 3.803404e-05, 3.892024e-05, 3.982708e-05,
       4.075505e-05, 4.170464e-05, 4.267636e-05, 4.367072e-05, 4.468825e-05, 4.572948e-05, 4.679498e-05, 4.788530e-05, 4.900103e-05, 5.014275e-05,
       5.131108e-05, 5.250663e-05, 5.373003e-05, 5.498193e-05, 5.626301e-05, 5.757396e-05, 5.891541e-05, 6.028813e-05, 6.169287e-05, 6.313031e-05,
       6.460123e-05, 6.610646e-05, 6.764675e-05, 6.922293e-05, 7.083579e-05, 7.248627e-05, 7.417520e-05, 7.590349e-05, 7.767202e-05, 7.948178e-05,
       8.133372e-05, 8.322878e-05, 8.516802e-05, 8.715241e-05, 8.918308e-05, 9.126106e-05, 9.338745e-05, 9.556335e-05, 9.778998e-05, 1.000685e-04,
       1.024001e-04, 1.047860e-04, 1.072275e-04, 1.097259e-04, 1.122826e-04, 1.148987e-04, 1.175759e-04, 1.203154e-04, 1.231187e-04, 1.259874e-04,
       1.289229e-04, 1.319268e-04, 1.350007e-04, 1.381462e-04, 1.413650e-04, 1.446588e-04, 1.480294e-04, 1.514785e-04, 1.550079e-04, 1.586196e-04,
       1.623155e-04, 1.660974e-04, 1.699675e-04, 1.739277e-04, 1.779802e-04, 1.821272e-04, 1.863707e-04, 1.907132e-04, 1.951568e-04, 1.997039e-04,
       2.043570e-04, 2.091186e-04, 2.139910e-04, 2.189770e-04, 2.240792e-04, 2.293002e-04, 2.346429e-04, 2.401101e-04, 2.457047e-04, 2.514296e-04,
       2.572879e-04, 2.632827e-04, 2.694172e-04, 2.756946e-04, 2.821183e-04, 2.886916e-04, 2.954182e-04, 3.023014e-04, 3.093450e-04, 3.165528e-04,
       3.239285e-04, 3.314760e-04, 3.391994e-04, 3.471027e-04, 3.551902e-04, 3.634661e-04, 3.719349e-04, 3.806010e-04, 3.894690e-04, 3.985436e-04,
       4.078297e-04, 4.173321e-04, 4.270560e-04, 4.370064e-04, 4.471886e-04, 4.576081e-04, 4.682704e-04, 4.791811e-04, 4.903460e-04, 5.017711e-04,
       5.134623e-04, 5.254263e-04, 5.376686e-04, 5.501960e-04, 5.630158e-04, 5.761336e-04, 5.895581e-04, 6.032948e-04, 6.173511e-04, 6.317354e-04,
       6.464550e-04, 6.615173e-04, 6.769307e-04, 6.927035e-04, 7.088431e-04, 7.253594e-04, 7.422603e-04, 7.595547e-04, 7.772525e-04, 7.953627e-04,
       8.138942e-04, 8.328579e-04, 8.522639e-04, 8.721215e-04, 8.924417e-04, 9.132357e-04, 9.345142e-04, 9.562885e-04, 9.785700e-04, 1.001371e-03,
       1.024703e-03, 1.048578e-03, 1.073010e-03, 1.098011e-03, 1.123595e-03, 1.149774e-03, 1.176564e-03, 1.203978e-03, 1.232031e-03, 1.260737e-03,
       1.290112e-03, 1.320172e-03, 1.350932e-03, 1.382409e-03, 1.414619e-03, 1.447579e-03, 1.481308e-03, 1.515823e-03, 1.551141e-03, 1.587283e-03,
       1.624266e-03, 1.662112e-03, 1.700839e-03, 1.740469e-03, 1.781022e-03, 1.822519e-03, 1.864984e-03, 1.908438e-03, 1.952905e-03, 1.998407e-03,
       2.044970e-03, 2.092618e-03, 2.141376e-03, 2.191270e-03, 2.242327e-03, 2.294573e-03, 2.348037e-03, 2.402746e-03, 2.458730e-03, 2.516018e-03,
       2.574641e-03, 2.634631e-03, 2.696018e-03, 2.758835e-03, 2.823116e-03, 2.888894e-03, 2.956205e-03, 3.025085e-03, 3.095569e-03, 3.167696e-03,
       3.241504e-03, 3.317031e-03, 3.394317e-03, 3.473405e-03, 3.554335e-03, 3.637151e-03, 3.721897e-03, 3.808617e-03, 3.897358e-03, 3.988166e-03,
       4.081091e-03, 4.176180e-03, 4.273485e-03, 4.373057e-03, 4.474950e-03, 4.579216e-03, 4.685912e-03, 4.795093e-03, 4.906819e-03, 5.021148e-03,
       5.138141e-03, 5.257857e-03, 5.380370e-03, 5.505732e-03, 5.634014e-03, 5.765287e-03, 5.899615e-03, 6.037076e-03, 6.177744e-03, 6.321682e-03,
       6.468978e-03, 6.619706e-03, 6.773944e-03, 6.931777e-03, 7.093288e-03, 7.258561e-03, 7.427685e-03, 7.600750e-03, 7.777849e-03, 7.959071e-03,
       8.144522e-03, 8.334285e-03, 8.528475e-03, 8.727188e-03, 8.930532e-03, 9.138613e-03, 9.351545e-03, 9.569435e-03, 9.792401e-03, 1.002057e-02,
       1.025404e-02, 1.049296e-02, 1.073745e-02, 1.098763e-02, 1.124364e-02, 1.150562e-02, 1.177370e-02, 1.204803e-02, 1.232875e-02, 1.261601e-02,
       1.290996e-02, 1.321076e-02, 1.351857e-02, 1.383356e-02, 1.415588e-02, 1.448571e-02, 1.482323e-02, 1.516861e-02, 1.552204e-02, 1.588370e-02,
       1.625379e-02, 1.663251e-02, 1.702004e-02, 1.741661e-02, 1.782242e-02, 1.823768e-02, 1.866262e-02, 1.909746e-02, 1.954243e-02, 1.999777e-02,
       2.046371e-02, 2.094052e-02, 2.142843e-02, 2.192771e-02, 2.243863e-02, 2.296145e-02, 2.349645e-02, 2.404392e-02, 2.460414e-02, 2.517742e-02,
       2.576405e-02, 2.636436e-02, 2.697864e-02, 2.760725e-02, 2.825050e-02, 2.890873e-02, 2.958231e-02, 3.027157e-02, 3.097690e-02, 3.169866e-02,
       3.243724e-02, 3.319303e-02, 3.396643e-02, 3.475784e-02, 3.556770e-02, 3.639643e-02, 3.724447e-02, 3.811226e-02, 3.900028e-02, 3.990899e-02,
       4.083886e-02, 4.179041e-02, 4.276413e-02, 4.376053e-02, 4.478015e-02, 4.582353e-02, 4.689122e-02, 4.798378e-02, 4.910180e-02, 5.024588e-02,
       5.141661e-02, 5.261462e-02, 5.384053e-02, 5.509500e-02, 5.637876e-02, 5.769238e-02, 5.903660e-02, 6.041216e-02, 6.181973e-02, 6.326015e-02,
       6.473410e-02, 6.624243e-02, 6.778586e-02, 6.936529e-02, 7.098150e-02, 7.263533e-02, 7.432773e-02, 7.605958e-02, 7.783177e-02, 7.964525e-02,
       8.150097e-02, 8.339996e-02, 8.534318e-02, 8.733166e-02, 8.936652e-02, 9.144874e-02, 9.357948e-02, 9.575989e-02, 9.799113e-02, 1.002743e-01,
       1.026107e-01, 1.050015e-01, 1.074481e-01, 1.099516e-01, 1.125135e-01, 1.151350e-01, 1.178177e-01, 1.205628e-01, 1.233719e-01, 1.262465e-01,
       1.291881e-01, 1.321981e-01, 1.352784e-01, 1.384303e-01, 1.416558e-01, 1.449563e-01, 1.483338e-01, 1.517900e-01, 1.553267e-01, 1.589458e-01,
       1.626493e-01, 1.664390e-01, 1.703170e-01, 1.742854e-01, 1.783463e-01, 1.825017e-01, 1.867540e-01, 1.911054e-01, 1.955581e-01, 2.001146e-01,
       2.047773e-01, 2.095486e-01, 2.144311e-01, 2.194274e-01, 2.245400e-01, 2.297718e-01, 2.351255e-01, 2.406039e-01, 2.462100e-01, 2.519467e-01,
       2.578170e-01, 2.638242e-01, 2.699713e-01, 2.762616e-01, 2.826985e-01, 2.892854e-01, 2.960257e-01, 3.029231e-01, 3.099812e-01, 3.172038e-01,
       3.245946e-01, 3.321577e-01, 3.398970e-01, 3.478166e-01, 3.559207e-01, 3.642136e-01, 3.726998e-01, 3.813837e-01, 3.902700e-01, 3.993633e-01,
       4.086684e-01, 4.181904e-01, 4.279342e-01, 4.379051e-01, 4.481083e-01, 4.585492e-01, 4.692334e-01, 4.801665e-01, 4.913544e-01, 5.028030e-01,
       5.145183e-01, 5.265067e-01, 5.387742e-01, 5.513278e-01, 5.641737e-01, 5.773188e-01, 5.907705e-01, 6.045355e-01, 6.186211e-01, 6.330348e-01,
       6.477843e-01, 6.628781e-01, 6.783229e-01, 6.941282e-01, 7.103007e-01, 7.268511e-01, 7.437866e-01, 7.611171e-01, 7.788511e-01, 7.969980e-01,
       8.155682e-01, 8.345713e-01, 8.540165e-01, 8.739150e-01, 8.942772e-01, 9.151141e-01, 9.364361e-01, 9.582549e-01, 9.805825e-01, 1.003430e+00,
       1.026810e+00, 1.050735e+00, 1.075217e+00, 1.100269e+00, 1.125905e+00, 1.152139e+00, 1.178984e+00, 1.206454e+00, 1.234565e+00, 1.263330e+00,
       1.292766e+00, 1.322887e+00, 1.353710e+00, 1.385252e+00, 1.417528e+00, 1.450557e+00, 1.484354e+00, 1.518940e+00, 1.554331e+00, 1.590547e+00,
       1.627607e+00, 1.665530e+00, 1.704337e+00, 1.744048e+00, 1.784684e+00, 1.826268e+00, 1.868820e+00, 1.912363e+00, 1.956921e+00, 2.002517e+00,
       2.049176e+00, 2.096922e+00, 2.145780e+00, 2.195777e+00, 2.246938e+00, 2.299292e+00, 2.352866e+00, 2.407687e+00, 2.463786e+00, 2.521193e+00,
       2.579936e+00, 2.640049e+00, 2.701562e+00, 2.764508e+00, 2.828922e+00, 2.894835e+00, 2.962285e+00, 3.031306e+00, 3.101936e+00, 3.174211e+00,
       3.248170e+00, 3.323852e+00, 3.401298e+00, 3.480548e+00, 3.561645e+00, 3.644631e+00, 3.729551e+00, 3.816450e+00, 3.905373e+00, 3.996368e+00,
       4.089484e+00, 4.184769e+00, 4.282274e+00, 4.382051e+00, 4.484153e+00, 4.588633e+00, 4.695548e+00, 4.804955e+00, 4.916910e+00, 5.031474e+00,
       5.148708e+00, 5.268671e+00, 5.391436e+00, 5.517055e+00, 5.645599e+00, 5.777144e+00, 5.911750e+00, 6.049494e+00, 6.190445e+00, 6.334686e+00,
       6.482281e+00, 6.633318e+00, 6.787876e+00, 6.946034e+00, 7.107875e+00, 7.273489e+00, 7.442964e+00, 7.616385e+00, 7.793845e+00, 7.975440e+00,
       8.161268e+00, 8.351429e+00, 8.546012e+00, 8.745139e+00, 8.948897e+00, 9.157407e+00, 9.370775e+00, 9.589114e+00, 9.812542e+00, 1.004117e+01,
       1.027317e+01, 1.051053e+01, 1.075338e+01, 1.100184e+01, 1.125603e+01, 1.151610e+01, 1.178218e+01, 1.205441e+01, 1.233292e+01, 1.261787e+01,
       1.290941e+01, 1.320768e+01, 1.351284e+01, 1.382505e+01, 1.414448e+01, 1.447129e+01, 1.480564e+01, 1.514773e+01, 1.549771e+01, 1.585579e+01,
       1.622213e+01, 1.659695e+01, 1.698042e+01, 1.737275e+01, 1.777414e+01, 1.818481e+01, 1.860497e+01, 1.903484e+01, 1.947463e+01, 1.992459e+01,
       2.019389e+01, 2.046682e+01, 2.074344e+01, 2.102379e+01, 2.130794e+01, 2.159593e+01, 2.188781e+01, 2.218363e+01, 2.248346e+01, 2.278733e+01,
       2.309531e+01, 2.340746e+01, 2.372382e+01, 2.404446e+01, 2.436943e+01, 2.469880e+01, 2.503262e+01, 2.537094e+01, 2.571385e+01, 2.606138e+01,
       2.641361e+01, 2.677061e+01, 2.713242e+01, 2.749913e+01, 2.787080e+01, 2.824749e+01, 2.862926e+01, 2.901620e+01, 2.940837e+01, 2.980584e+01,
       3.009166e+01, 3.038022e+01, 3.067155e+01, 3.096567e+01, 3.126261e+01, 3.156240e+01, 3.186507e+01, 3.217064e+01, 3.247913e+01, 3.279059e+01,
       3.310503e+01, 3.342249e+01, 3.374299e+01, 3.406657e+01, 3.439324e+01, 3.472305e+01, 3.505603e+01, 3.539219e+01, 3.573158e+01, 3.607423e+01,
       3.642016e+01, 3.676941e+01, 3.712200e+01, 3.747798e+01, 3.783737e+01, 3.820021e+01, 3.856653e+01, 3.893636e+01, 3.930973e+01, 3.968669e+01,
       3.998188e+01, 4.027927e+01, 4.057888e+01, 4.088071e+01, 4.118478e+01, 4.149112e+01, 4.179974e+01, 4.211065e+01, 4.242387e+01, 4.273942e+01,
       4.305733e+01, 4.337759e+01, 4.370024e+01, 4.402529e+01, 4.435275e+01, 4.468265e+01, 4.501501e+01, 4.534983e+01, 4.568715e+01, 4.602698e+01,
       4.636933e+01, 4.671423e+01, 4.706170e+01, 4.741175e+01, 4.776440e+01, 4.811968e+01, 4.847760e+01, 4.883818e+01, 4.920145e+01, 4.956741e+01,
       4.986865e+01, 5.017172e+01, 5.047664e+01, 5.078340e+01, 5.109203e+01, 5.140254e+01, 5.171493e+01, 5.202922e+01, 5.234543e+01, 5.266356e+01,
       5.298359e+01, 5.330562e+01, 5.362958e+01, 5.395549e+01, 5.428338e+01, 5.461332e+01, 5.494520e+01, 5.527912e+01, 5.561508e+01, 5.595309e+01,
       5.629314e+01, 5.663523e+01, 5.697942e+01, 5.732571e+01, 5.767409e+01, 5.802462e+01, 5.837725e+01, 5.873202e+01, 5.908900e+01, 5.944807e+01,
       5.975354e+01, 6.006058e+01, 6.036919e+01, 6.067938e+01, 6.099119e+01, 6.130457e+01, 6.161957e+01, 6.193620e+01, 6.225446e+01, 6.257433e+01,
       6.289589e+01, 6.321907e+01, 6.354393e+01, 6.387041e+01, 6.419861e+01, 6.452845e+01, 6.486006e+01, 6.519330e+01, 6.552832e+01, 6.586502e+01,
       6.620345e+01, 6.654366e+01, 6.688554e+01, 6.722921e+01, 6.757465e+01, 6.792194e+01, 6.827089e+01, 6.862169e+01, 6.897431e+01, 6.932872e+01,
       6.963733e+01, 6.994726e+01, 7.025859e+01, 7.057135e+01, 7.088546e+01, 7.120099e+01, 7.151788e+01, 7.183624e+01, 7.215596e+01, 7.247715e+01,
       7.279975e+01, 7.312377e+01, 7.344926e+01, 7.377615e+01, 7.410457e+01, 7.443441e+01, 7.476571e+01, 7.509848e+01, 7.543276e+01, 7.576852e+01,
       7.610574e+01, 7.644453e+01, 7.678479e+01, 7.712652e+01, 7.746982e+01, 7.781464e+01, 7.816103e+01, 7.850889e+01, 7.885837e+01, 7.920937e+01,
       7.952034e+01, 7.983257e+01, 8.014600e+01, 8.046064e+01, 8.077654e+01, 8.109369e+01, 8.141205e+01, 8.173167e+01, 8.205259e+01, 8.237473e+01,
       8.269811e+01, 8.302281e+01, 8.334877e+01, 8.367604e+01, 8.400451e+01, 8.433434e+01, 8.466543e+01, 8.499783e+01, 8.533154e+01, 8.566656e+01,
       8.600290e+01, 8.634059e+01, 8.667954e+01, 8.701985e+01, 8.736153e+01, 8.770451e+01, 8.804886e+01, 8.839452e+01, 8.874159e+01, 8.908997e+01,
       8.940288e+01, 8.971684e+01, 9.003195e+01, 9.034811e+01, 9.066542e+01, 9.098388e+01, 9.130339e+01, 9.162406e+01, 9.194582e+01, 9.226874e+01,
       9.259281e+01, 9.291798e+01, 9.324430e+01, 9.357178e+01, 9.390041e+01, 9.423019e+01, 9.456112e+01, 9.489326e+01, 9.522650e+01, 9.556094e+01,
       9.589654e+01, 9.623334e+01, 9.657130e+01, 9.691046e+01, 9.725082e+01, 9.759239e+01, 9.793512e+01, 9.827905e+01, 9.862423e+01, 9.897062e+01,
       9.928505e+01, 9.960048e+01, 9.991690e+01, 1.002343e+02, 1.005528e+02, 1.008722e+02, 1.011927e+02, 1.015142e+02, 1.018367e+02, 1.021602e+02,
       1.024848e+02, 1.028104e+02, 1.031370e+02, 1.034647e+02, 1.037934e+02, 1.041232e+02, 1.044540e+02, 1.047858e+02, 1.051187e+02, 1.054527e+02,
       1.057877e+02, 1.061238e+02, 1.064609e+02, 1.067992e+02, 1.071385e+02, 1.074788e+02, 1.078203e+02, 1.081629e+02, 1.085065e+02])


LISA_signal_response_function_one_armed_power = np.array(
      [1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01,
       1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.500000e-01, 1.499459e-01,
       1.501543e-01, 1.498621e-01, 1.499323e-01, 1.499193e-01, 1.500063e-01, 1.499914e-01, 1.498757e-01, 1.500625e-01, 1.500393e-01, 1.498941e-01,
       1.499813e-01, 1.499910e-01, 1.499849e-01, 1.500440e-01, 1.499732e-01, 1.500271e-01, 1.500182e-01, 1.500439e-01, 1.499906e-01, 1.500412e-01,
       1.499937e-01, 1.499962e-01, 1.500501e-01, 1.500018e-01, 1.500179e-01, 1.500075e-01, 1.500124e-01, 1.500182e-01, 1.499975e-01, 1.499926e-01,
       1.499962e-01, 1.500017e-01, 1.500031e-01, 1.500008e-01, 1.500006e-01, 1.499953e-01, 1.499949e-01, 1.499914e-01, 1.499924e-01, 1.499944e-01,
       1.500025e-01, 1.499996e-01, 1.499951e-01, 1.499999e-01, 1.500005e-01, 1.499993e-01, 1.499994e-01, 1.500028e-01, 1.499984e-01, 1.500010e-01,
       1.499992e-01, 1.500009e-01, 1.500014e-01, 1.499993e-01, 1.500013e-01, 1.499991e-01, 1.499988e-01, 1.500003e-01, 1.499996e-01, 1.499991e-01,
       1.499988e-01, 1.499991e-01, 1.499991e-01, 1.499994e-01, 1.499987e-01, 1.499992e-01, 1.499992e-01, 1.499987e-01, 1.499988e-01, 1.499986e-01,
       1.499987e-01, 1.499981e-01, 1.499988e-01, 1.499982e-01, 1.499985e-01, 1.499985e-01, 1.499981e-01, 1.499981e-01, 1.499981e-01, 1.499980e-01,
       1.499979e-01, 1.499979e-01, 1.499977e-01, 1.499977e-01, 1.499975e-01, 1.499974e-01, 1.499972e-01, 1.499972e-01, 1.499970e-01, 1.499969e-01,
       1.499967e-01, 1.499965e-01, 1.499964e-01, 1.499962e-01, 1.499959e-01, 1.499958e-01, 1.499956e-01, 1.499953e-01, 1.499952e-01, 1.499949e-01,
       1.499946e-01, 1.499944e-01, 1.499942e-01, 1.499939e-01, 1.499936e-01, 1.499934e-01, 1.499930e-01, 1.499927e-01, 1.499923e-01, 1.499920e-01,
       1.499916e-01, 1.499913e-01, 1.499908e-01, 1.499903e-01, 1.499899e-01, 1.499894e-01, 1.499890e-01, 1.499884e-01, 1.499879e-01, 1.499873e-01,
       1.499867e-01, 1.499860e-01, 1.499855e-01, 1.499848e-01, 1.499841e-01, 1.499833e-01, 1.499824e-01, 1.499816e-01, 1.499808e-01, 1.499799e-01,
       1.499790e-01, 1.499779e-01, 1.499769e-01, 1.499758e-01, 1.499747e-01, 1.499735e-01, 1.499722e-01, 1.499709e-01, 1.499696e-01, 1.499682e-01,
       1.499666e-01, 1.499650e-01, 1.499634e-01, 1.499617e-01, 1.499598e-01, 1.499579e-01, 1.499560e-01, 1.499539e-01, 1.499518e-01, 1.499495e-01,
       1.499470e-01, 1.499446e-01, 1.499420e-01, 1.499392e-01, 1.499363e-01, 1.499333e-01, 1.499303e-01, 1.499269e-01, 1.499234e-01, 1.499198e-01,
       1.499161e-01, 1.499122e-01, 1.499080e-01, 1.499037e-01, 1.498992e-01, 1.498944e-01, 1.498894e-01, 1.498842e-01, 1.498788e-01, 1.498731e-01,
       1.498670e-01, 1.498608e-01, 1.498543e-01, 1.498474e-01, 1.498402e-01, 1.498327e-01, 1.498248e-01, 1.498166e-01, 1.498079e-01, 1.497988e-01,
       1.497893e-01, 1.497795e-01, 1.497690e-01, 1.497581e-01, 1.497468e-01, 1.497348e-01, 1.497223e-01, 1.497092e-01, 1.496956e-01, 1.496812e-01,
       1.496662e-01, 1.496505e-01, 1.496341e-01, 1.496168e-01, 1.495988e-01, 1.495798e-01, 1.495600e-01, 1.495394e-01, 1.495177e-01, 1.494950e-01,
       1.494712e-01, 1.494463e-01, 1.494203e-01, 1.493930e-01, 1.493644e-01, 1.493345e-01, 1.493032e-01, 1.492703e-01, 1.492361e-01, 1.492001e-01,
       1.491625e-01, 1.491231e-01, 1.490819e-01, 1.490387e-01, 1.489935e-01, 1.489463e-01, 1.488967e-01, 1.488448e-01, 1.487906e-01, 1.487338e-01,
       1.486743e-01, 1.486121e-01, 1.485469e-01, 1.484787e-01, 1.484073e-01, 1.483325e-01, 1.482543e-01, 1.481725e-01, 1.480867e-01, 1.479971e-01,
       1.479032e-01, 1.478049e-01, 1.477021e-01, 1.475944e-01, 1.474819e-01, 1.473640e-01, 1.472407e-01, 1.471117e-01, 1.469767e-01, 1.468354e-01,
       1.466877e-01, 1.465329e-01, 1.463712e-01, 1.462020e-01, 1.460250e-01, 1.458396e-01, 1.456460e-01, 1.454434e-01, 1.452314e-01, 1.450098e-01,
       1.447779e-01, 1.445356e-01, 1.442821e-01, 1.440171e-01, 1.437401e-01, 1.434504e-01, 1.431476e-01, 1.428312e-01, 1.425004e-01, 1.421546e-01,
       1.417934e-01, 1.414159e-01, 1.410216e-01, 1.406097e-01, 1.401794e-01, 1.397299e-01, 1.392607e-01, 1.387707e-01, 1.382591e-01, 1.377251e-01,
       1.371677e-01, 1.365862e-01, 1.359793e-01, 1.353464e-01, 1.346862e-01, 1.339977e-01, 1.332800e-01, 1.325319e-01, 1.317522e-01, 1.309399e-01,
       1.300938e-01, 1.292127e-01, 1.282953e-01, 1.273406e-01, 1.263473e-01, 1.253141e-01, 1.242397e-01, 1.231229e-01, 1.219626e-01, 1.207572e-01,
       1.195058e-01, 1.182070e-01, 1.168597e-01, 1.154626e-01, 1.140147e-01, 1.125148e-01, 1.109619e-01, 1.093552e-01, 1.076937e-01, 1.059764e-01,
       1.042030e-01, 1.023727e-01, 1.004851e-01, 9.853989e-02, 9.653700e-02, 9.447655e-02, 9.235875e-02, 9.018412e-02, 8.795341e-02, 8.566764e-02,
       8.332812e-02, 8.093650e-02, 7.849472e-02, 7.600516e-02, 7.347058e-02, 7.089407e-02, 6.827922e-02, 6.563005e-02, 6.295115e-02, 6.024752e-02,
       5.752470e-02, 5.478880e-02, 5.204640e-02, 4.930470e-02, 4.657143e-02, 4.385477e-02, 4.116355e-02, 3.850706e-02, 3.589496e-02, 3.333748e-02,
       3.084513e-02, 2.842870e-02, 2.609922e-02, 2.386788e-02, 2.174577e-02, 1.974391e-02, 1.787301e-02, 1.614333e-02, 1.456451e-02, 1.314535e-02,
       1.189361e-02, 1.081577e-02, 9.916862e-03, 9.200107e-03, 8.666817e-03, 8.316109e-03, 8.144684e-03, 8.146610e-03, 8.313258e-03, 8.633109e-03,
       9.091687e-03, 9.671654e-03, 1.035279e-02, 1.111224e-02, 1.192476e-02, 1.276309e-02, 1.359853e-02, 1.440146e-02, 1.514214e-02, 1.579155e-02,
       1.632234e-02, 1.670979e-02, 1.693294e-02, 1.697556e-02, 1.682720e-02, 1.648407e-02, 1.594971e-02, 1.523549e-02, 1.436075e-02, 1.335253e-02,
       1.224491e-02, 1.107786e-02, 9.895565e-03, 8.744306e-03, 7.669990e-03, 6.715233e-03, 5.916486e-03, 5.301062e-03, 4.884625e-03, 4.669149e-03,
       4.641825e-03, 4.775061e-03, 5.027824e-03, 5.348403e-03, 5.678547e-03, 5.958835e-03, 6.134753e-03, 6.162998e-03, 6.017228e-03, 5.692419e-03,
       5.206925e-03, 4.601707e-03, 3.936231e-03, 3.281126e-03, 2.708240e-03, 2.279307e-03, 2.034981e-03, 1.986314e-03, 2.110701e-03, 2.353891e-03,
       2.636361e-03, 2.876134e-03, 2.998850e-03, 2.956616e-03, 2.740923e-03, 2.387145e-03, 1.968075e-03, 1.576475e-03, 1.299934e-03, 1.194435e-03,
       1.264840e-03, 1.459919e-03, 1.686029e-03, 1.837518e-03, 1.835049e-03, 1.657986e-03, 1.356479e-03, 1.034789e-03, 8.087459e-04, 7.531846e-04,
       8.635563e-04, 1.053584e-03, 1.195855e-03, 1.189383e-03, 1.018974e-03, 7.690436e-04, 5.761498e-04, 5.423352e-04, 6.632118e-04, 8.248612e-04,
       8.783485e-04, 8.745669e-04, 8.101724e-04, 6.997052e-04, 5.718728e-04, 4.611706e-04, 3.971086e-04, 3.943827e-04, 4.474117e-04, 5.315438e-04,
       6.111163e-04, 6.520404e-04, 6.345889e-04, 5.614684e-04, 4.575385e-04, 3.605398e-04, 3.058727e-04, 3.114110e-04, 3.690265e-04, 4.472590e-04,
       5.049100e-04, 5.101017e-04, 4.560236e-04, 3.652040e-04, 2.790962e-04, 2.371246e-04, 2.555412e-04, 3.177505e-04, 3.825940e-04, 4.073586e-04,
       3.887271e-04, 3.438814e-04, 2.857917e-04, 2.319242e-04, 1.985148e-04, 1.949993e-04, 2.205519e-04, 2.640962e-04, 3.080108e-04, 3.344060e-04,
       3.317895e-04, 2.995980e-04, 2.487022e-04, 1.974218e-04, 1.643695e-04, 1.608569e-04, 1.860106e-04, 2.268478e-04, 2.635958e-04, 2.782362e-04,
       2.626335e-04, 2.224969e-04, 1.750612e-04, 1.411931e-04, 1.353931e-04, 1.584909e-04, 1.968728e-04, 2.290488e-04, 2.366041e-04, 2.140042e-04,
       1.819763e-04, 1.479227e-04, 1.225620e-04, 1.136675e-04, 1.232799e-04, 1.468700e-04, 1.748518e-04, 1.960054e-04, 2.016272e-04, 1.888691e-04,
       1.619464e-04, 1.306355e-04, 1.065223e-04, 9.839557e-05, 1.086158e-04, 1.320092e-04, 1.578725e-04, 1.743940e-04, 1.737045e-04, 1.553844e-04,
       1.267961e-04, 9.993883e-05, 8.608552e-05, 9.057472e-05, 1.102055e-04, 1.345998e-04, 1.510683e-04, 1.507680e-04, 1.331575e-04, 1.064256e-04,
       8.680727e-05, 7.617916e-05, 7.781201e-05, 9.059368e-05, 1.093575e-04, 1.267127e-04, 1.357541e-04, 1.326673e-04, 1.182317e-04, 9.759545e-05,
       7.834212e-05, 6.754330e-05, 6.893133e-05, 8.134359e-05, 9.912163e-05, 1.143806e-04, 1.202724e-04, 1.139003e-04, 9.762130e-05, 7.810841e-05,
       6.349379e-05, 5.978312e-05, 6.812534e-05, 8.420925e-05, 1.001511e-04, 1.080957e-04, 1.039042e-04, 8.917943e-05, 7.058682e-05, 5.669546e-05,
       5.341806e-05, 5.892350e-05, 7.084252e-05, 8.444512e-05, 9.436675e-05, 9.661351e-05, 9.009443e-05, 7.707895e-05, 6.236464e-05, 5.143819e-05,
       4.831915e-05, 5.393741e-05, 6.571449e-05, 7.856045e-05, 8.692548e-05, 8.709056e-05, 7.874823e-05, 6.517900e-05, 5.190111e-05, 4.432575e-05,
       4.540303e-05, 5.429498e-05, 6.669922e-05, 7.673283e-05, 7.957552e-05, 7.368772e-05, 6.156549e-05, 4.862937e-05, 4.070960e-05, 4.127708e-05,
       4.828538e-05, 5.850321e-05, 6.794498e-05, 7.289987e-05, 7.133557e-05, 6.369228e-05, 5.274286e-05, 4.254775e-05, 3.688476e-05, 3.775839e-05,
       4.458373e-05, 5.439192e-05, 6.300346e-05, 6.671992e-05, 6.385066e-05, 5.543878e-05, 4.485563e-05, 3.640478e-05, 3.349968e-05, 3.718614e-05,
       4.566012e-05, 5.502062e-05, 6.096179e-05, 6.068032e-05, 5.414837e-05, 4.415872e-05, 3.508549e-05, 3.089364e-05, 3.329783e-05, 4.093647e-05,
       4.899495e-05, 5.500650e-05, 5.658556e-05, 5.302514e-05, 4.558480e-05, 3.702562e-05, 3.055404e-05, 2.857191e-05, 3.172097e-05, 3.860839e-05,
       4.634181e-05, 5.167823e-05, 5.233652e-05, 4.794071e-05, 4.019433e-05, 3.219552e-05, 2.715530e-05, 2.704590e-05, 3.175122e-05, 3.909607e-05,
       4.576396e-05, 4.872780e-05, 4.657830e-05, 4.016285e-05, 3.223154e-05, 2.622425e-05, 2.472457e-05, 2.827511e-05, 3.510678e-05, 4.193060e-05,
       4.530638e-05, 4.465962e-05, 4.016015e-05, 3.345320e-05, 2.703868e-05, 2.330853e-05, 2.361072e-05, 2.770932e-05, 3.386416e-05, 3.951195e-05,
       4.228944e-05, 4.099184e-05, 3.607440e-05, 2.948114e-05, 2.385534e-05, 2.144663e-05, 2.316504e-05, 2.818425e-05, 3.427528e-05, 3.874477e-05,
       3.958841e-05, 3.636462e-05, 3.040146e-05, 2.423060e-05, 2.048053e-05, 2.070927e-05, 2.469782e-05, 3.053341e-05, 3.546296e-05, 3.714346e-05,
       3.511593e-05, 3.042770e-05, 2.482488e-05, 2.041280e-05, 1.883992e-05, 2.064828e-05, 2.505010e-05, 3.022811e-05, 3.405068e-05, 3.492370e-05,
       3.243802e-05, 2.754566e-05, 2.218252e-05, 1.848157e-05, 1.789295e-05, 2.057566e-05, 2.532073e-05, 3.004945e-05, 3.268731e-05, 3.204871e-05,
       2.835301e-05, 2.314142e-05, 1.861870e-05, 1.669494e-05, 1.814313e-05, 2.224716e-05, 2.710748e-05, 3.048094e-05, 3.078786e-05])


def LISA_S_noise(f):
    """
    Compute the (effective) LISA instrumental noise power spectral density.

    Parameters
    ----------
    f : array_like
        Frequency(ies) in Hz at which to evaluate the noise PSD.

    Returns
    -------
    S_n : numpy.ndarray
        Noise power spectral density evaluated at `f`, with implicity units of 1/Hz.
    """
    
    L, f_star = 2.5e9,  19.09e-3

    P_OMS   = (1.5e-11)**2 * ( 1 + (2e-3/f)**4 ) 
    P_acc   = (3e-15)**2 * ( 1 + (0.4e-3/f)**2 ) * (1 + (f/8e-3)**4 ) 
    P_noise = 1/(L**2) * ( P_OMS + 2*(1+np.cos(f/f_star)**2)*P_acc/(2*np.pi*f)**4 ) 
    
    R = np.interp(f, LISA_signal_response_function_fscaled*f_star, 2*LISA_signal_response_function_one_armed_power)
    
    return P_noise/R


def calc_n_geo(N_fou, c_0):
    """
    Compute the number of linear Fourier bins in each geometric re-binning bin.

    Parameters
    ----------
    N_fou : int
        Total number of linear Fourier bins to be re-binned (typically `len(P_j)`).

    c_0 : float
        Geometric growth factor (> 1). Larger values create more aggressive
        re-binning at higher frequencies.

    Returns
    -------
    n_geo : numpy.ndarray
        1D integer array giving the number of linear bins in each geometric bin.
    """
    
    l_sat = np.floor(np.log(N_fou*(1-1/c_0)+1)/np.log(c_0)) # Last Saturated l
    n_geo = (c_0**(1+np.arange(l_sat))).astype(int)
    
    dN = N_fou - sum(n_geo)
    if dN > 0:
        n_geo = np.append(n_geo, [dN])
    
    return n_geo
    

def calc_geo_max(l, n_l):
    """
    Compute maximum number of points in the l-th geometric bin.
    
    Parameters
    ----------
    l : int
        Geometric bin index.
    
    n_l : array_like
        Integer array of bin sizes, as returned by `calc_n_geo`.
    
    Returns
    -------
    idx : int
        Cumulative number of elements in bins below `l`.
    """

    return int(np.sum([ n_l[ell] for ell in range(l) ]))


def calc_f_geo_max(l, n_l, df):
    """
    Compute the maximum frequency associated with the l-th geometric bin.

    Parameters
    ----------
    l : int
        Geometric bin index.

    n_l : array_like
        Integer array of geometric-bin sizes, e.g. output of `calc_n_geo`.

    df : float
        Linear Fourier frequency spacing in Hz.

    Returns
    -------
    f_edge : float
        Upper-edge frequency (Hz) of the l-th geometric bin..
    """
    
    return (np.sum([ n_l[ell] for ell in range(l) ]) + 1/2 )*df


def calc_LISA_signal(M_chirp, D, f_orb, ecc=None, phases=None, T_obs = 4*u.yr, f_max = 1*u.Hz, c_0 = 1.5, sf=1, noise=False, noise_subtract=False, lineout=True): #  dt = 0.5,
    """
    Calculate a simple (geometricly binned) LISA power spectrum for a set of
    compact binaries, optionally including eccentric harmonics and an additive 
    Gaussian-noise realisation.

    Parameters
    ----------
    M_chirp : array_like or astropy.units.Quantity
        Chirp mass(es). If a Quantity, must be convertible to solar masses.
        If not a Quantity, values are interpreted as Msun.
    
    D : array_like or astropy.units.Quantity
        Luminosity distance(s). If a Quantity, must be convertible to kpc.
        If not a Quantity, values are interpreted as kpc.
    
    f_orb : array_like or astropy.units.Quantity
        Orbital frequency(ies). If a Quantity, must be convertible to Hz.
        If not a Quantity, values are interpreted as Hz.
    
    ecc : array_like, optional
        Orbital eccentricity(ies), with 0 <= e < 1. If None, all sources are
        assumed circular (e = 0).
    
    phases : array_like, optional
        Initial phase(s) in radians for each source's complex Fourier amplitude.
        If None, phases are drawn uniformly on [0, 2*pi).
    
    T_obs : float or astropy.units.Quantity, optional
        Observation time. If a Quantity, must be convertible to seconds.
        If not a Quantity, interpreted as years. Default: 4 yr.
    
    f_max : float or astropy.units.Quantity, optional
        Maximum frequency included in the (linear) Fourier grid. If a Quantity,
        must be convertible to Hz. If not a Quantity, interpreted as Hz.
        Default: 1 Hz.
    
    c_0 : float, optional
        Geometric re-binning ratio (> 1). The l-th geometric bin contains
        approximately c_0^l linear Fourier bins until saturation. Default: 1.5.
    
    sf : float, optional
        Overall scale factor applied to the spectrum via P_j = (sf/df)|...|^2.
        Default: 1.
    
    noise : bool, optional
        If True, add a complex Gaussian noise realisation whose variance is
        determined by `LISA_S_noise(f)`. Default: False.
    
    noise_subtract : bool, optional
        If True and `noise=True`, subtract the expected noise level
        `LISA_S_noise(f)` from the noisy spectrum after adding noise.
        Default: False.
    
    lineout : bool, optional
        If True, show tqdm progress output for the different processes.
        Default: True.
    
    Returns
    -------
    f_l : astropy.units.Quantity
        Geometrically re-binned frequency array (bin centers), in Hz.
    
    P_l : astropy.units.Quantity
        Geometrically re-binned power spectrum, with units of 1/Hz.
        
    err_l : astropy.units.Quantity
        Estimated 1Ïƒ uncertainty per geometric bin, with units of 1/Hz.
    """
    
    # ---- Convert to numpy arrays ----
    M_chirp = np.atleast_1d(M_chirp)
    D       = np.atleast_1d(D)
    f_orb   = np.atleast_1d(f_orb)
    ecc     = np.atleast_1d(ecc) if ecc is not None else ecc
    phases  = np.atleast_1d(phases) if phases is not None else phases


    # ---- Validate and enforce units ----
    try:
        M_chirp = M_chirp.to(u.Msun).value if isinstance(M_chirp, u.Quantity) else M_chirp
    except u.UnitConversionError:
        raise u.UnitConversionError("M_chirp must be an astropy.units.Quantity with units of mass (e.g. astropy.units.Msun).")
    
    try:
        D = D.to(u.kpc).value if isinstance(D, u.Quantity) else D
    except u.UnitConversionError:
        raise u.UnitConversionError("D must be an astropy.units.Quantity with units of length (e.g. astropy.units.kpc).")
         
    try:
        f_orb = f_orb.to(u.Hz).value if isinstance(f_orb, u.Quantity) else f_orb
    except u.UnitConversionError:
        raise u.UnitConversionError("f_orb must be an astropy.units.Quantity with units of frequency (e.g. astropy.units.Hz).")
    
    try:
        T_obs = T_obs.to(u.s).value if isinstance(T_obs, u.Quantity) else T_obs * (1*u.yr).to(u.s).value
    except u.UnitConversionError:
        raise u.UnitConversionError("T_obs must be an astropy.units.Quantity with units of time (e.g. astropy.units.yr).")
        
    try:
        f_max = f_max.to(u.Hz).value if isinstance(f_max, u.Quantity) else f_max
    except u.UnitConversionError:
        raise u.UnitConversionError("f_max must be an astropy.units.Quantity with units of frequency (e.g. astropy.units.Hz).")
    
    
    # ---- Ensure same length ----
    lengths = np.array([np.size(M_chirp), np.size(D), np.size(f_orb)]) 
    if not np.all(lengths == lengths[0]):
        raise ValueError("Input arrays must have the same length, got lengths: " + f"M_chirp={lengths[0]}, D={lengths[1]}, f_orb={lengths[2]}" + (f", ecc={np.size(ecc)}" if ecc is not None else "" ) +(f", phases={np.size(phases)}" if phases is not None else "" ) + ".")
    
    
    # ---- c_0 validation ----
    if not isinstance(c_0, (int, float)):
        raise TypeError("c_0 must be a float or integer value.")
    elif c_0 <= 1:
        raise ValueError("c_0 must satisfy c_0 > 1.")


    # ---- Handle eccentricity ----
    if ecc is None:
        ecc = np.zeros(np.size(M_chirp))
    elif np.any((ecc < 0) | (ecc >= 1)):
        raise ValueError("Eccentricity must satisfy 0 <= e < 1.")


    # ---- Handle phases ----
    if phases is None:
        phases = np.random.uniform(0, 2*np.pi, np.size(M_chirp))
    
    
    # ---- Calculate Amplitudes ----
    A_circ = ( 4*(const.G*M_chirp*u.Msun)**(5/3)/(D*u.kpc*const.c**4) * np.sqrt(4/5) * (2*np.pi*f_orb*u.Hz)**(2/3) ).decompose().value
    
    f = np.array(2*f_orb, dtype=object) 
    A = np.array(A_circ, dtype=object)
    
    if np.any(ecc > 0):
        
        def G_scalar(eta, e): # G = sqrt(g)/(eta/2) : Relative Amplitude radiated into harmonic
            j_values = jv(np.array([eta-2, eta-1, eta, eta+1, eta+2]), eta*e)
            g_1 = j_values[0] - 2*e*j_values[1] + 2/eta*j_values[2] + 2*e*j_values[3] - j_values[4]
            g_2 = j_values[0] - 2*j_values[2] + j_values[4]
            return eta/2**(3/2) * np.sqrt( g_1**2 + (1-e**2)*g_2**2 + 4/(3*eta**2)*(j_values[2])**2 )
        
        def eta_cutoff(e): # This is the emperical harmonic cutoff for G(eta, e) >= 0.1
            return np.minimum(np.ceil( 3 + ( 1 - e + 0.2*e**2 - 0.1*e**10 )**(-3) ).astype(int), 331)
        
        for i in tqdm(np.where(ecc > 0)[0], desc="Calculating Harmonics", disable=not(lineout)):
            e   = ecc[i]
            eta = np.arange(1, eta_cutoff(e) + 1 )
            G   = np.array([G_scalar(k, e) for k in eta])
            
            G_01 = G >= 1e-1
            f[i] = eta[G_01] * f_orb[i]
            A[i] = G[G_01] * A_circ[i]
    
    pbar = tqdm(total=1, desc="       Fourier Signal", disable=not(lineout))
    
    f = np.hstack(f)
    A_iphi = np.hstack(A*np.exp(1j*phases))
    
    
    # ---- Calculate Fourier Signal ----
    df  = 1/T_obs
    N   = int(2*(f_max/df)) # 2*f_max for nyquist limit.
    f_j = np.arange(N/2+1)*df
    
    complex_sum = np.zeros(np.size(f_j), dtype=complex)
    np.add.at(complex_sum, np.digitize(f[f<=f_max], np.concatenate((f_j - df/2, [f_j[-1] + df/2]))) - 1, A_iphi[f<=f_max])
    
    P_j = sf/df * np.abs( complex_sum )**2
    
    pbar.update(1)
    pbar.close()
    
    
    # ---- Simulate Noise ----
    if noise:
        pbar = tqdm(total=1, desc="     Simulating Noise", disable=not(lineout))
        
        rng = np.random.default_rng()
        std = np.sqrt(0.5*LISA_S_noise(f_j[1:]))
        
        P_j += np.append([0], np.abs(rng.normal(0, std) + 1j*rng.normal(0, std))**2)
        
        if noise_subtract:
            P_j -= np.append([0], LISA_S_noise(f_j[1:]))
        
        pbar.update(1)
        pbar.close()

    
    # ---- Geometric re-binning ----
    pbar = tqdm(total=1, desc=" Geometric Re-Binning", disable=not(lineout))
    
    J = len(P_j)

    n_l = calc_n_geo(J, c_0) # Array of integer number of fourier bins in the l-th geometric bin

    P_l = np.zeros(len(n_l))
    f_l = np.zeros(len(n_l))
    err_l = np.zeros(len(n_l))
    
    for l in range(len(n_l)): # Now do the actual geometric rebinning
        
        P_j_bin_slice = P_j[calc_geo_max(l, n_l):calc_geo_max(l+1, n_l)]
        
        P_l[l] = 1/n_l[l] * np.sum( P_j_bin_slice )
        f_l[l] = (calc_f_geo_max(l+1, n_l, df) + calc_f_geo_max(l, n_l, df))/2
    
        err_l[l] = 1/np.sqrt(n_l[l]) * np.std(P_j[calc_geo_max(l, n_l):calc_geo_max(l+1, n_l)])
    
    pbar.update(1)
    pbar.close()
    
    return f_l[1:]*u.Hz, P_l[1:]/u.Hz, err_l[1:]/u.Hz

